<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sex Stories</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background-color: #f5ecd8;
      margin: 0;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      text-align: center;
      color: #4a2c1e;
      font-size: 24px;
      margin: 10px 0;
      width: 100%;
      max-width: 800px;
    }
    h1 span {
      font-size: 16px;
      color: #4a2c1e;
    }
    .nav-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #d2b48c;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
      width: 100%;
      max-width: 800px;
      flex-wrap: wrap;
    }
    .nav-bar select {
      width: 45%;
      padding: 5px;
      border: none;
      background-color: #d2b48c;
      color: #4a2c1e;
      font-size: 16px;
      text-align: center;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      cursor: pointer;
      background-image: url('data:image/svg+xml;utf8,<svg fill="%234a2c1e" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 10px center;
    }
    .nav-bar input[type="text"] {
      width: 45%;
      padding: 5px;
      border: none;
      border-radius: 3px;
      background-color: #fff;
      color: #4a2c1e;
      font-size: 16px;
      text-align: center;
    }
    .nav-bar input[type="text"]::placeholder {
      color: #4a2c1e;
      opacity: 0.7;
    }
    .nav-bar a {
      color: #4a2c1e;
      text-decoration: none;
      font-size: 16px;
    }
    .nav-bar a:hover {
      text-decoration: underline;
    }
    .container {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .post {
      background-color: #fff;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      cursor: pointer;
      width: 100%;
      max-width: 800px;
    }
    .post:hover {
      background-color: #f9f9f9;
    }
    .post-position {
      font-size: 16px;
      font-weight: bold;
      color: #4a2c1e;
      margin-bottom: 10px;
      text-align: center;
    }
    .post-title {
      font-size: 18px;
      color: #4a2c1e;
      margin: 0 0 10px;
      overflow-wrap: break-word;
      word-break: break-word;
      hyphens: auto;
      text-align: center;
    }
    .post-title:hover {
      color: #6b3e26;
    }
    .post-message {
      font-size: 16px;
      color: #34495e;
      margin-bottom: 10px;
      overflow-wrap: break-word;
      word-break: break-word;
      hyphens: auto;
      text-align: center;
    }
    .post-tags {
      font-size: 14px;
      color: #666;
      overflow-wrap: break-word;
      word-break: break-word;
      hyphens: auto;
      text-align: center;
    }
    .post-tags span {
      color: #4a2c1e;
      margin-right: 5px;
      white-space: nowrap;
    }
    .error {
      color: #e74c3c;
      text-align: center;
      font-size: 16px;
      padding: 20px;
      background-color: #fff;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 800px;
    }
    .speech-error {
      color: #e74c3c;
      font-size: 14px;
      text-align: center;
      margin: 10px 0;
    }
    .play-button, .share-button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
      color: #4a2c1e;
      margin: 10px 5px;
      display: inline-block;
      transition: color 0.3s;
    }
    .play-button:hover, .share-button:hover {
      color: #6b3e26;
    }
    .play-button.playing {
      color: #e74c3c;
    }
    .play-button:disabled {
      color: #ccc;
      cursor: not-allowed;
    }
    .share-button {
      font-size: 18px;
    }
    @media (max-width: 600px) {
      .post {
        padding: 10px;
      }
      .post-position {
        font-size: 14px;
      }
      .post-title {
        font-size: 16px;
      }
      .post-message {
        font-size: 14px;
      }
      .post-tags {
        font-size: 12px;
      }
      .play-button, .share-button {
        font-size: 18px;
      }
      .speech-error {
        font-size: 12px;
      }
      .nav-bar select, .nav-bar input[type="text"] {
        width: 100%;
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <h1>Sex Stories <br> <span>‡§Ö‡§Ç‡§§‡§∞‡•ç‡§µ‡§æ‡§∏‡§®‡§æ ‡§∏‡•á‡§ï‡•ç‡§∏ ‡§ï‡§π‡§æ‡§®‡§ø‡§Ø‡§æ‡§Å</span></h1>

  <div class="nav-bar">
    <select id="tag-filter">
      <option value="">All Tags ‚ñº</option>
    </select>
    <input type="text" id="search-input" placeholder="Search posts...">
  </div>

  <div class="container" id="data-container">
  </div>

  <script>
    // OpenSheet API URL (Ensure this Google Sheet is publicly shared)
    const SHEET_JSON_URL = 'https://opensheet.elk.sh/12ztLodAK-rcTxscpNl5Niyo5tByci6hvkXSpYfse4uQ/Sheet1';

    // Store fetched data globally
    let allPosts = [];

    // Sample data as a fallback if the Google Sheet fails to load
    const sampleData = [
      {
        Title: "Sample Story 1",
        Message: "This is a sample story message. It has multiple sentences. Each sentence should be read separately. This is to test the line-by-line reading feature.",
        Tags: "romance, drama"
      },
      {
        Title: "Sample Story 2",
        Message: "A shorter message. It has two sentences. Let's see how it works.",
        Tags: "comedy, love"
      }
    ];

    // Fetch and process JSON data
    function fetchSheetData() {
      const container = document.getElementById('data-container');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">Loading data...</div>';

      fetch(SHEET_JSON_URL)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Network response was not ok: ${response.status} - ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Fetched data:', data);
          if (data && data.length > 0) {
            allPosts = data;
            console.log('All posts:', allPosts);
            populateTagFilter();
            displayPostsByFragment();
          } else {
            console.warn('No data found in Google Sheet, using sample data instead.');
            allPosts = sampleData;
            populateTagFilter();
            displayPostsByFragment();
          }
        })
        .catch(error => {
          console.error('Error fetching data:', error);
          displayError(`Error fetching data: ${error.message}. Using sample data instead. Please ensure the Google Sheet is publicly shared and the URL is correct.`);
          allPosts = sampleData;
          populateTagFilter();
          displayPostsByFragment();
        });
    }

    // Populate the tag filter dropdown with unique tags from posts
    function populateTagFilter() {
      const select = document.getElementById('tag-filter');
      select.innerHTML = '<option value="">All Tags ‚ñº</option>';
      const allTags = new Set();
      allPosts.forEach(row => {
        if (row.Tags) {
          row.Tags.split(',').map(tag => tag.trim()).forEach(tag => allTags.add(tag));
        }
      });
      const sortedTags = Array.from(allTags).sort((a, b) => a.localeCompare(b));
      console.log('Populating dropdown with tags:', sortedTags);
      sortedTags.forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tag;
        select.appendChild(option);
      });
      select.addEventListener('change', filterPostsByTag);
    }

    // Filter posts based on selected tag
    function filterPostsByTag() {
      const selectedTag = document.getElementById('tag-filter').value;
      const searchQuery = document.getElementById('search-input').value.toLowerCase();
      let filteredPosts = allPosts;
      if (selectedTag) {
        filteredPosts = allPosts.filter(row => {
          if (!row.Tags) return false;
          const tags = row.Tags.split(',').map(tag => tag.trim());
          return tags.includes(selectedTag);
        });
      }
      // Apply search filter if search query exists
      if (searchQuery) {
        filteredPosts = filteredPosts.filter(row => {
          const title = (row.Title || '').toLowerCase();
          const message = (row.Message || '').toLowerCase();
          const tags = (row.Tags || '').toLowerCase();
          return title.includes(searchQuery) || message.includes(searchQuery) || tags.includes(searchQuery);
        });
      }
      // Map filtered posts to their original indices to preserve correct post IDs
      const postsWithIndices = filteredPosts.map(row => ({
        row,
        originalIndex: allPosts.indexOf(row)
      }));
      displayPosts(postsWithIndices);
    }

    // Add search input event listener
    function setupSearch() {
      const searchInput = document.getElementById('search-input');
      searchInput.addEventListener('input', filterPostsByTag);
    }

    // Function to split message into lines (sentences)
    function splitIntoLines(text) {
      if (!text) return ['No message provided'];
      const sentences = text.match(/[^.!?]+[.!?]|\S+/g) || [text];
      return sentences.map(s => s.trim()).filter(s => s);
    }

    // Display posts based on URL fragment or all posts
    function displayPostsByFragment() {
      const fragment = window.location.hash; // e.g., "#post-1"
      if (fragment && fragment.startsWith('#post-')) {
        const postId = parseInt(fragment.replace('#post-', '')); // Extract the ID (e.g., 1)
        const postIndex = allPosts.length - postId; // Map postId to index (reverse order)
        if (postIndex >= 0 && postIndex < allPosts.length) {
          // Display only the specific post
          displayPosts([{ row: allPosts[postIndex], originalIndex: postIndex }], postId);
        } else {
          displayError(`Post with ID ${postId} not found.`);
        }
      } else {
        // Display all posts in reverse order
        const postsWithIndices = allPosts.map((row, index) => ({
          row,
          originalIndex: index
        })).reverse();
        displayPosts(postsWithIndices);
      }
    }

    // Display posts in the container
    function displayPosts(postsWithIndices, forcedPosition = null) {
      const container = document.getElementById('data-container');
      container.innerHTML = '';
      if (postsWithIndices.length === 0) {
        container.innerHTML = '<div class="error">No posts found for the selected tag or search query.</div>';
        return;
      }
      postsWithIndices.forEach(({ row, originalIndex }) => {
        // Calculate position: use forcedPosition for single post, else use original index in reverse order
        const position = forcedPosition !== null ? forcedPosition : allPosts.length - originalIndex;
        const title = row.Title;
        let message = row.Message || 'No message provided';
        const tags = row.Tags;
        const postDiv = document.createElement('div');
        postDiv.className = 'post';
        postDiv.id = `post-${position}`; // Set the post ID
        let isExpanded = forcedPosition !== null; // Expand if single post

        // Add position number
        const positionElement = document.createElement('div');
        positionElement.className = 'post-position';
        positionElement.textContent = `#${position}`;
        postDiv.appendChild(positionElement);

        const titleElement = document.createElement('h2');
        titleElement.className = 'post-title';
        titleElement.textContent = title || 'Untitled';
        postDiv.appendChild(titleElement);

        const messageElement = document.createElement('p');
        messageElement.className = 'post-message';
        const readMoreSpan = document.createElement('strong');
        readMoreSpan.style.cursor = 'pointer';
        readMoreSpan.style.color = '#4a2c1e';

        // Function to update message display
        function updateMessageDisplay() {
          if (isExpanded) {
            messageElement.textContent = message;
            readMoreSpan.textContent = 'read less';
          } else if (message.length > 250) {
            const truncatedMessage = message.substring(0, 250);
            messageElement.textContent = `${truncatedMessage}... `;
            readMoreSpan.textContent = 'read more';
          } else {
            messageElement.textContent = message;
            readMoreSpan.textContent = '';
          }
          if (readMoreSpan.textContent) {
            messageElement.appendChild(readMoreSpan);
          }
        }

        // Initial display
        updateMessageDisplay();

        // Toggle message on click
        postDiv.addEventListener('click', (e) => {
          if (e.target === readMoreSpan || e.target.classList.contains('play-button') || e.target.classList.contains('share-button')) {
            e.stopPropagation();
            return;
          }
          isExpanded = !isExpanded;
          updateMessageDisplay();
        });

        // Handle click on read more/less
        readMoreSpan.addEventListener('click', (e) => {
          e.stopPropagation();
          isExpanded = !isExpanded;
          updateMessageDisplay();
        });

        postDiv.appendChild(messageElement);

        // Check for Web Speech API support
        if ('speechSynthesis' in window) {
          // Add play/pause button
          const playButton = document.createElement('button');
          playButton.className = 'play-button';
          playButton.innerHTML = '‚ñ∂';
          playButton.setAttribute('aria-label', 'Play audio');
          playButton.setAttribute('tabindex', '0');
          let isPlaying = false;
          let currentLineIndex = 0;
          const lines = splitIntoLines(message);
          let continueReading = false;

          // Function to speak the current line and continue to the next
          function speakLine() {
            if (!continueReading || currentLineIndex >= lines.length) {
              isPlaying = false;
              continueReading = false;
              playButton.innerHTML = '‚ñ∂';
              playButton.classList.remove('playing');
              playButton.setAttribute('aria-label', 'Play audio');
              currentLineIndex = 0;
              return;
            }

            const textToSpeak = lines[currentLineIndex];
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'en-US';
            utterance.onend = () => {
              currentLineIndex++;
              if (currentLineIndex >= lines.length) {
                currentLineIndex = 0;
              }
              speakLine();
            };
            window.speechSynthesis.speak(utterance);
            isPlaying = true;
            playButton.innerHTML = '‚è∏';
            playButton.classList.add('playing');
            playButton.setAttribute('aria-label', 'Pause audio');
          }

          playButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const speech = window.speechSynthesis;

            if (isPlaying) {
              speech.cancel();
              isPlaying = false;
              continueReading = false;
              playButton.innerHTML = '‚ñ∂';
              playButton.classList.remove('playing');
              playButton.setAttribute('aria-label', 'Play audio');
            } else {
              continueReading = true;
              speakLine();
            }
          });

          postDiv.appendChild(playButton);
        } else {
          // Display error message for unsupported browsers
          const errorMessage = document.createElement('div');
          errorMessage.className = 'speech-error';
          errorMessage.textContent = '‡§Ü‡§™‡§ï‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§∏‡•ç‡§™‡•Ä‡§ö ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§ (Your browser does not support speech.)';
          postDiv.appendChild(errorMessage);
        }

        // Add share button
        const shareButton = document.createElement('button');
        shareButton.className = 'share-button';
        shareButton.innerHTML = 'üîó';
        shareButton.setAttribute('aria-label', 'Share post');
        shareButton.setAttribute('tabindex', '0');
        shareButton.addEventListener('click', (e) => {
          e.stopPropagation();
          const shareUrl = `${window.location.origin}${window.location.pathname}#post-${position}`;
          const shareData = {
            title: title || 'Untitled',
            text: message.substring(0, 100) + '...',
            url: shareUrl
          };

          if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
            navigator.share(shareData)
              .then(() => console.log('Shared successfully'))
              .catch(err => console.error('Error sharing:', err));
          } else {
            // Fallback: Copy URL to clipboard
            navigator.clipboard.writeText(shareUrl)
              .then(() => alert('Post URL copied to clipboard!'))
              .catch(err => console.error('Failed to copy:', err));
          }
        });
        postDiv.appendChild(shareButton);

        const tagsElement = document.createElement('div');
        tagsElement.className = 'post-tags';
        if (tags) {
          const tagList = tags.split(',').map(tag => tag.trim());
          tagList.forEach(tag => {
            const tagSpan = document.createElement('span');
            tagSpan.textContent = tag;
            tagsElement.appendChild(tagSpan);
          });
        } else {
          tagsElement.textContent = 'No tags';
        }
        postDiv.appendChild(tagsElement);
        container.appendChild(postDiv);
      });
    }

    // Display error message
    function displayError(message) {
      const container = document.getElementById('data-container');
      container.innerHTML = `<div class="error">${message}</div>`;
    }

    // Load data when the page loads
    window.onload = () => {
      fetchSheetData();
      setupSearch();
    };
  </script>
</body>
</html>
